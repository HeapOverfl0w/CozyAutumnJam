<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="login.css" type="text/css">
    <link rel="stylesheet" href="style.css" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  </head>
  <body>
    <div style="display:none">
      <img id="homebackdrop" src="./game/rsc/homebackdrop.png" />
      <img id="homebackdrop1" src="./game/rsc/homebackdrop1.png" />
      <img id="craftbackdrop" src="./game/rsc/craftbackdrop.png" />
      <img id="stick" src="./game/rsc/stick.png" />
      <img id="redLeaf" src="./game/rsc/redLeaf.png" />
      <img id="yellowLeaf" src="./game/rsc/yellowLeaf.png" />
      <img id="orangeLeaf" src="./game/rsc/orangeLeaf.png" />
      <img id="blackPaintTriangle" src="./game/rsc/blackPaintTriangle.png" />
      <img id="whitePaintTriangle" src="./game/rsc/whitePaintTriangle.png" />
      <img id="blackPaintCircle" src="./game/rsc/blackPaintCircle.png" />
      <img id="whitePaintCircle" src="./game/rsc/whitePaintCircle.png" />
      <img id="blackPaintStripe" src="./game/rsc/blackPaintStripe.png" />
      <img id="whitePaintStripe" src="./game/rsc/whitePaintStripe.png" />
      <img id="feather" src="./game/rsc/feather.png" />
      <img id="pineCone" src="./game/rsc/pineCone.png" />
      <img id="woodBoard" src="./game/rsc/woodBoard.png" />
      <img id="corn" src="./game/rsc/corn.png" />
      <img id="skull" src="./game/rsc/skull.png" />
      <img id="candle" src="./game/rsc/candle.png" />
      <img id="bottle" src="./game/rsc/bottle.png" />
      <img id="bone" src="./game/rsc/bone.png" />
      <img id="pumpkin" src="./game/rsc/pumpkin.png" />
      <img id="googlyEyes" src="./game/rsc/googlyEyes.png" />
      <img id="straw" src="./game/rsc/straw.png" />
      <img id="scarf" src="./game/rsc/scarf.png" />
      <img id="rope" src="./game/rsc/rope.png" />
      <img id="tire" src="./game/rsc/tire.png" />
      <img id="sheet" src="./game/rsc/sheet.png" />
      <img id="witchHat" src="./game/rsc/witchHat.png" />
      <img id="hoodie" src="./game/rsc/hoodie.png" />
      <img id="broom" src="./game/rsc/broom.png" />
      <img id="metal" src="./game/rsc/metal.png" />
      <img id="pumpkinPie" src="./game/rsc/pumpkinPie.png" />
      <img id="pitchFork" src="./game/rsc/pitchFork.png" />
      <img id="rock" src="./game/rsc/rock.png" />
      <img id="overalls" src="./game/rsc/overalls.png" />
      <img id="sword" src="./game/rsc/sword.png" />
      <img id="chair" src="./game/rsc/chair.png" />
      <img id="cinderBlock" src="./game/rsc/cinderBlock.png" />
      <img id="metalPipe" src="./game/rsc/metalPipe.png" />
      <img id="bark" src="./game/rsc/bark.png" />
      <img id="beerCan" src="./game/rsc/beerCan.png" />
      <audio id="hellacioushilltops">
        <source src="./game/rsc/hellacioushilltops.mp3" type="audio/mp3">
      </audio>
      <audio id="click">
        <source src="./game/rsc/click.wav" type="audio/wav">
      </audio>
      <audio id="woodhammer">
        <source src="./game/rsc/woodhammer.wav" type="audio/wave">
      </audio>
    </div>
    <!-- The Modal -->
    <div id="myModal" class="modal">
      <!-- Modal content -->
      <div class="modal-content">
        <h2 class="title">Colorfest!</h2>
        <img class="gameArt" src="banner.png"/>
        <div class="logoCircle">
          <img class="logo" src="A_ZX2K.png"/>
        </div>
        <div id='lgnForm' style="text-align: center;">
          <form >
            <input id="lgnUserName" type="username" placeholder="USER NAME"/>
            <input id="lgnPassword" type="password" style="margin-bottom: 1rem;" placeholder="PASSWORD"/>
            <button id="lgnBtn" type="submit" class="login">LOGIN</button>
          </form>
          <div class="text">
            <!--<p style="margin-top: 1rem;"><span>Forgot Login?</span></p>-->
            <p style="margin-bottom: 1rem;">Don't have an account?  <span id="regBtn">Sign Up</span></p>
          </div>
        </div>
        <div id="regForm" class="regForm">
          <form>
            <input id="regUsername" type="username" placeholder="USERNAME" maxlength="20"/>
            <input id="regPassword" type="password" placeholder="PASSWORD" maxlength="20"/>
            <div class="row">
              <button id="sbmtBtn" type="submit" class="register">SUBMIT</button>
              <button id="cnclBtn" type="buton" class="register">CANCEL</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div id="gamePage" class="gamePage">
      <div id="navbar" class="topnav">
      </div>
      <div id="userinfo">
      </div>
      <div id="craftinfo">
      </div>
      <table>
        <tr>
          <td>
            <canvas id="scene"></canvas>
          </td>
          <td id="sidepanel">
            <ul id="menulist" style="list-style-type:none;overflow:auto;padding:5px;"></ul>
            <input id="chatbox" maxlength="100"/>
            <button id="undo">Undo</button>
          </td>
        </tr>
      </table>
    </div>
    <div class="modal" id="modal">
      <div class="modal-content">
        <div class="modal-sub-content" id="name-input">
          <p>Name :</p>
          <input id="name" maxlength="30"/>
        </div>
        <div class="modal-sub-content" id="price-input">
          <p>Price :</p>
          <input id="price" type="number" min="1" step="1"/>
        </div>
        <div class="row">
          <button id="okButton">OK</button>
          <button id="cancelButton">Cancel</button>
        </div>        
      </div>
    </div>
  </body>
  <script src='./identityagent.js'></script>
  <script src='./lib/vanilla-toast.min.js'></script>
  <script src="./game/audiohandler.js"></script>
  <script src='./game/vector2d.js'></script>
  <script src="./game/consts.js"></script>
  <script src="./game/client.js"></script>
  <script src="./game/home.js"></script>
  <script src="./game/buycrafts.js"></script>
  <script src="./game/crafts.js"></script>
  <script src="./game/createcraft.js"></script>
  <script src="./game/main.js"></script>
  <script>
    // Get the controls
    var lgnForm = document.getElementById("lgnForm");
    var regForm = document.getElementById("regForm");
    var gamePage = document.getElementById("gamePage");
    var modal = document.getElementById("myModal");

    // Get the button that opens the modal
    var regBtn = document.getElementById("regBtn");
    var cnclBtn = document.getElementById("cnclBtn");


    var cancelButton = document.getElementById("cancelButton");
    var extraModal = document.getElementById("modal");
    extraModal.style.display = "none";
    cancelButton.onclick = function () {
      let extraModal = document.getElementById("modal");
      extraModal.style.display = "none";
    }

    HIDE_CRAFT_INFO();
  
    //var logoutBtn = document.getElementById("logoutBtn");

    var userData = undefined;

    var identity = new IdentityAgent();
    var token = identity.getToken();
    if (token && token !== 'undefined') {
      identity.getUserData().then(response => {
        if (response.status) {
          identity.clearToken();
        } else {
          userData = response;
          modal.style.display = "none";
          gamePage.style.display = "block";
          startGame();
        }
      });
    }

    lgnForm.onsubmit = function() {
      var username = document.getElementById('lgnUserName').value;
      var password = document.getElementById('lgnPassword').value;
      identity.login(username, password).then(response => {
        if (response.status) {
          vt.error('Login Attempt Failed: Invalid User Name and/or Password');
        } else {
          userData = response;
          identity.setToken(response.token);
          modal.style.display = "none";
          gamePage.style.display = "block";
          startGame();
          vt.success('Login Succeeded!');
        }
      });
      return false;
    }

    regForm.onsubmit = function() {
      var username = document.getElementById('regUsername').value;
      var password = document.getElementById('regPassword').value;
      identity.register(username, password).then(response => {
        if (response.status) {
          var message = 'Register Attempt Failed';
          if (response.errors) {
            if (response.errors.error) {
              message += ': ' + response.errors.error[0];
            }
          vt.error(message);
          } else {
            userData = response;
            identity.setToken(response.token);
            modal.style.display = "none";
            gamePage.style.display = "block";
            vt.success('Account Created!');
          }
        }
        else if (response.token) {
          userData = response;
          identity.setToken(response.token);
          modal.style.display = "none";
          gamePage.style.display = "block";
          startGame();
          vt.success('Account Created!');
        }
      });
      return false;
    }
    
    // When the user clicks the button, open the modal 
    cnclBtn.onclick = function() {
      lgnForm.style.display = "block";
      regForm.style.display = "none";
      gamePage.style.display = "none";
    }
    
    // When the user clicks on <span> (x), close the modal
    regBtn.onclick = function() {
      lgnForm.style.display = "none";
      regForm.style.display = "block";
      gamePage.style.display = "none";
    }

    var logoutCallback = function() {
      window.clearInterval(gameTimer);
      menu.home.disconnectFromChat();
      identity.clearToken();
      regForm.style.display = "none";
      gamePage.style.display = "none";   
      lgnForm.style.display = "block";   
      modal.style.display = "block";  
    }



    //********  Game Start Code  ***********
    var cvs = document.getElementById("scene");
    var ctx = cvs.getContext("2d");
    ctx.imageSmoothingEnabled = false;
    var menu;
    var gameTimer;

    var startGame = function() {     
      let menulist = document.getElementById("menulist");
      menulist.style.height = (window.innerHeight - 140) + "px";
      menulist.scrollTop = menulist.scrollHeight;

      menu = new Main(userData, identity, logoutCallback);
      gameTimer = window.setInterval((menu) => {
        if (menu !== undefined) {
          menu.draw(ctx);
        }
      }, 1000/30, menu);
    }

    window.onkeyup = function (event) {
      if (menu !== undefined)
        menu.onKeyUp(event.keyCode);
    };

    window.onkeydown = function (event) {
      if (menu !== undefined)
        menu.onKeyDown(event.keyCode);
    };

    cvs.addEventListener('mousemove', function(event){
        if (menu !== undefined)
          menu.onMouseOver(new Vector2D(event.clientX / cvs.clientWidth * cvs.width, event.clientY / cvs.clientHeight * cvs.height));
    });

    cvs.addEventListener('mouseup', function(event){
        if (menu !== undefined)
            menu.onMouseClick(new Vector2D(event.clientX / cvs.clientWidth * cvs.width, event.clientY / cvs.clientHeight * cvs.height));
    });

    window.onresize = function() {
      CHANGE_CANVAS_RESOLTUION(cvs.width, cvs.height);

      let menulist = document.getElementById("menulist");
      menulist.style.height = (window.innerHeight - 140) + "px";
      menulist.scrollTop = menulist.scrollHeight;
    };

  </script>
</html>