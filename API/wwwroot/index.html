<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="login.css" type="text/css">
    <link rel="stylesheet" href="style.css" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  </head>
  <body>
    <div style="display:none">
      <img id="homebackdrop" src="./game/rsc/homebackdrop.png" />
      <img id="craftbackdrop" src="./game/rsc/craftbackdrop.png" />
      <img id="stick" src="./game/rsc/stick.png" />
    </div>
    <!-- The Modal -->
    <div id="myModal" class="modal">
      <!-- Modal content -->
      <div class="modal-content">
        <h2 class="title">Colorfest!</h2>
        <img class="gameArt" src="banner.png"/>
        <div class="logoCircle">
          <img class="logo" src="A_ZX2K.png"/>
        </div>
        <div id='lgnForm' style="text-align: center;">
          <form >
            <input id="lgnUserName" type="username" placeholder="USER NAME"/>
            <input id="lgnPassword" type="password" style="margin-bottom: 1rem;" placeholder="PASSWORD"/>
            <button id="lgnBtn" type="submit" class="login">LOGIN</button>
          </form>
          <div class="text">
            <!--<p style="margin-top: 1rem;"><span>Forgot Login?</span></p>-->
            <p style="margin-bottom: 1rem;">Don't have an account?  <span id="regBtn">Sign Up</span></p>
          </div>
        </div>
        <div id="regForm" class="regForm">
          <form>
            <input id="regUsername" type="username" placeholder="USERNAME"/>
            <input id="regPassword" type="password" placeholder="PASSWORD"/>
            <div class="row">
              <button id="sbmtBtn" type="submit" class="register">SUBMIT</button>
              <button id="cnclBtn" class="register">CANCEL</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div id="gamePage" class="gamePage">
      <div id="navbar" class="topnav">
      </div>
      <table>
        <tr>
          <td>
            <canvas id="scene"></canvas>
          </td>
          <td id="sidepanel">
            <ul id="menulist" style="list-style-type:none;overflow: auto"></ul>
            <input id="chatbox" maxlength="100"/>
          </td>
        </tr>
      </table>
    </div>
  </body>
  <script src='./identityagent.js'></script>
  <script src='./lib/vanilla-toast.min.js'></script>
  <script src='./game/vector2d.js'></script>
  <script src="./game/consts.js"></script>
  <script src="./game/client.js"></script>
  <script src="./game/home.js"></script>
  <script src="./game/buycrafts.js"></script>
  <script src="./game/crafts.js"></script>
  <script src="./game/createcraft.js"></script>
  <script src="./game/main.js"></script>
  <script>
    // Get the controls
    var lgnForm = document.getElementById("lgnForm");
    var regForm = document.getElementById("regForm");
    var gamePage = document.getElementById("gamePage");
    var modal = document.getElementById("myModal");

    // Get the button that opens the modal
    var regBtn = document.getElementById("regBtn");
    var cnclBtn = document.getElementById("cnclBtn");
  
    //var logoutBtn = document.getElementById("logoutBtn");

    var userData = undefined;

    var identity = new IdentityAgent();
    var token = identity.getToken();
    if (token && token !== 'undefined') {
      identity.getUserData().then(response => {
        if (response.status) {
          identity.clearToken();
        } else {
          userData = response;
          modal.style.display = "none";
          gamePage.style.display = "block";
          startGame();
        }
      });
    }

    lgnForm.onsubmit = function() {
      var username = document.getElementById('lgnUserName').value;
      var password = document.getElementById('lgnPassword').value;
      identity.login(username, password).then(response => {
        if (response.status) {
          vt.error('Login Attempt Failed: Invalid User Name and/or Password');
        } else {
          userData = response;
          identity.setToken(response.token);
          modal.style.display = "none";
          gamePage.style.display = "block";
          startGame();
          vt.success('Login Succeeded!');
        }
      });
      return false;
    }

    regForm.onsubmit = function() {
      var username = document.getElementById('regUsername').value;
      var password = document.getElementById('regPassword').value;
      identity.register(username, password).then(response => {
        if (response.status) {
          var message = 'Register Attempt Failed';
          if (response.errors) {
            if (response.errors.error) {
              message += ': ' + response.errors.error[0];
            }
          vt.error(message);
          } else {
            userData = response;
            identity.setToken(response.token);
            modal.style.display = "none";
            gamePage.style.display = "block";
            vt.success('Account Created!');
          }
        }
        else if (response.token) {
          userData = response;
          identity.setToken(response.token);
          modal.style.display = "none";
          gamePage.style.display = "block";
          startGame();
          vt.success('Account Created!');
        }
      });
      return false;
    }
    
    // When the user clicks the button, open the modal 
    cnclBtn.onclick = function() {
      lgnForm.style.display = "block";
      regForm.style.display = "none";
      gamePage.style.display = "none";
    }
    
    // When the user clicks on <span> (x), close the modal
    regBtn.onclick = function() {
      lgnForm.style.display = "none";
      regForm.style.display = "block";
      gamePage.style.display = "none";
    }

    logoutCallback = function() {
      identity.clearToken();
      regForm.style.display = "none";
      gamePage.style.display = "none";   
      lgnForm.style.display = "block";    
    }

    //********  Game Start Code  ***********
    var cvs = document.getElementById("scene");
    var ctx = cvs.getContext("2d");
    ctx.imageSmoothingEnabled = false;
    var menu;
    var gameTimer;

    var startGame = function() {      
      menu = new Main(userData, identity, logoutCallback);
      gameTimer = window.setInterval((menu) => {
        if (menu !== undefined) {
          menu.draw(ctx);
        }
      }, 1000/30, menu);
    }

    window.onkeyup = function (event) {
      if (menu !== undefined)
        menu.onKeyUp(event.keyCode);
    };

    window.onkeydown = function (event) {
      if (menu !== undefined)
        menu.onKeyDown(event.keyCode);
    };

    cvs.addEventListener('mousemove', function(event){
        if (menu !== undefined)
          menu.onMouseOver(new Vector2D(event.clientX / cvs.clientWidth * cvs.width, event.clientY / cvs.clientHeight * cvs.height));
    });

    cvs.addEventListener('mouseup', function(event){
        if (menu !== undefined)
            menu.onMouseClick(new Vector2D(event.clientX / cvs.clientWidth * cvs.width, event.clientY / cvs.clientHeight * cvs.height));
    });

  </script>
</html>